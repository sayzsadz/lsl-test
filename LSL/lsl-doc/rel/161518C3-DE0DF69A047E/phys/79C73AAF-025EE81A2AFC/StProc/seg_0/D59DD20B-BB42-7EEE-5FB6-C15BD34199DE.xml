<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureOraclev10g class="oracle.dbtools.crest.model.design.storage.oracle.v10g.StoredProcedureOraclev10g" name="CREATE_PAY_SUM_TAKINGS" directorySegmentName="seg_0" id="D59DD20B-BB42-7EEE-5FB6-C15BD34199DE">
<sourceConnName>LSL_Cloud_apex</sourceConnName>
<sourceObjSchema>APEX</sourceObjSchema>
<sourceObjName>CREATE_PAY_SUM_TAKINGS</sourceObjName>
<createdBy>sjayasinghe1</createdBy>
<createdTime>2019-04-29 11:48:25 UTC</createdTime>
<ownerDesignName>lsl-doc</ownerDesignName>
<owner>FB5DE12D-4EA4-254B-AA97-4ED35945C6A7</owner>
<source>CREATE OR REPLACE PROCEDURE APEX.CREATE_PAY_SUM_TAKINGS (p_data  IN  CLOB)&lt;br/&gt;AS&lt;br/&gt;&lt;br/&gt;  l_data           varchar2(20000);&lt;br/&gt;  l_buffer         varchar2(32767);&lt;br/&gt;  l_amount         number;&lt;br/&gt;  l_offset         number;&lt;br/&gt;&lt;br/&gt;BEGIN&lt;br/&gt;    l_data := p_data;&lt;br/&gt;    --l_data := &apos;[{&quot;date&quot;:&quot;2018-06-04T00:00:00&quot;,&quot;products&quot;:[{&quot;saleSummaryID&quot;:1,&quot;date&quot;:&quot;2018-06-04T00:00:00&quot;,&quot;productId&quot;:&quot;d06bd7ed-6fe1-4a36-9050-d49d36966b71&quot;,&quot;partNumber&quot;:&quot;000001&quot;,&quot;title&quot;:&quot;Product One&quot;,&quot;avgCostEx&quot;:4.5455,&quot;avgCostTax&quot;:0.4546,&quot;unit&quot;:&quot;Each&quot;,&quot;totalUnits&quot;:1.000,&quot;totalValueEx&quot;:18.1800,&quot;totalValueTax&quot;:1.8200}]}]&apos;;&lt;br/&gt;&lt;br/&gt;   INSERT INTO paymentsummary (&lt;br/&gt;                                      PAYMENTDATE,&lt;br/&gt;                                      PaymentTypesID,&lt;br/&gt;                                      TransactionId&lt;br/&gt;                                      )&lt;br/&gt;                        SELECT *&lt;br/&gt;                        FROM &lt;br/&gt;                             JSON_TABLE(&lt;br/&gt;                             l_data&lt;br/&gt;                             , &apos;$[*]&apos; COLUMNS (&lt;br/&gt;                              PAYMENTDATE varchar2(30) PATH &apos;$.date&apos;,&lt;br/&gt;                                      NESTED PATH &apos;$.creditCardTransactions[*]&apos; COLUMNS (&lt;br/&gt;                                                   PaymentTypesID   number      PATH &apos;$.transactionId&apos;,                           &lt;br/&gt;                                                   TransactionId   number      PATH &apos;$.transactionId&apos;&lt;br/&gt;                        )&lt;br/&gt;                        &lt;br/&gt;                        )) JT;&lt;br/&gt;  &lt;br/&gt;  INSERT INTO paymenttypesummary (&lt;br/&gt;                                  PaymentTypeDate,&lt;br/&gt;                                  PaymentType,&lt;br/&gt;                                  TotalValue,&lt;br/&gt;                                  PAYMENTTYPESID&lt;br/&gt;                                 )&lt;br/&gt;                        SELECT  PaymentTypeDate,&lt;br/&gt;                                PaymentType,&lt;br/&gt;                                TotalValue,&lt;br/&gt;                                TransactionId&lt;br/&gt;                        FROM &lt;br/&gt;                             JSON_TABLE(&lt;br/&gt;                             l_data&lt;br/&gt;                             , &apos;$[*]&apos; COLUMNS (&lt;br/&gt;                             PaymentTypeDate varchar2(30) PATH &apos;$.date&apos;&lt;br/&gt;                             ,NESTED PATH  &apos;$.paymentTypes[*]&apos; COLUMNS (&lt;br/&gt;                                                                        PaymentType   VARCHAR2(50)      PATH &apos;$.paymentType&apos;,&lt;br/&gt;                                                                        TotalValue   number       PATH &apos;$.totalValue&apos;&lt;br/&gt;                                                                        )&lt;br/&gt;                             ,NESTED PATH &apos;$.creditCardTransactions[*]&apos; COLUMNS (&lt;br/&gt;                                                                                  TransactionId   number      PATH &apos;$.transactionId&apos;&lt;br/&gt;                                                                                )&lt;br/&gt;&lt;br/&gt;                            )) JT;&lt;br/&gt;&lt;br/&gt;  INSERT INTO CreditCardTransaction (&lt;br/&gt;                                      TransactionId,&lt;br/&gt;                                      CreditCardType,&lt;br/&gt;                                      TransactionDate,&lt;br/&gt;                                      Amount,&lt;br/&gt;                                      ReferenceNumber&lt;br/&gt;                                    )&lt;br/&gt;                        SELECT TransactionId&lt;br/&gt;                              ,CreditCardType&lt;br/&gt;                              ,TransactionDate&lt;br/&gt;                              ,Amount&lt;br/&gt;                              ,ReferenceNumber&lt;br/&gt;                        FROM &lt;br/&gt;                             JSON_TABLE(&lt;br/&gt;                             l_data&lt;br/&gt;                             , &apos;$.creditCardTransactions[*]&apos; COLUMNS (&lt;br/&gt;                                                                              TransactionId   number      PATH &apos;$.transactionId&apos;,&lt;br/&gt;                                                                              CreditCardType   varchar2(20)      PATH &apos;$.creditCardType&apos;,&lt;br/&gt;                                                                              TransactionDate   varchar2(100)      PATH &apos;$.transactionDate&apos;,&lt;br/&gt;                                                                              Amount   number      PATH &apos;$.amount&apos;,&lt;br/&gt;                                                                              ReferenceNumber   number      PATH &apos;$.referenceNumber&apos;&lt;br/&gt;                                                                              )&lt;br/&gt;                        &lt;br/&gt;                              ) JT;             &lt;br/&gt;&lt;br/&gt;&lt;br/&gt;            &lt;br/&gt;            COMMIT;&lt;br/&gt;--&lt;br/&gt;--  l_amount := 32000;&lt;br/&gt;--  l_offset := 1;&lt;br/&gt;--  &lt;br/&gt;--        begin&lt;br/&gt;--            loop&lt;br/&gt;--                dbms_lob.read( l_clob, l_amount, l_offset, l_buffer );&lt;br/&gt;--                htp.p(l_buffer);&lt;br/&gt;--                l_offset := l_offset + l_amount;&lt;br/&gt;--                l_amount := 32000;&lt;br/&gt;--            end loop;&lt;br/&gt;--        exception&lt;br/&gt;--            when no_data_found then&lt;br/&gt;--                DBMS_OUTPUT.put_line(&apos;Message: unsuccessful operation&apos;);c v&lt;br/&gt;--            when others then&lt;br/&gt;--                DBMS_OUTPUT.put_line(SQLERRM);&lt;br/&gt;--        end;&lt;br/&gt;&lt;br/&gt;END;</source>
</StoredProcedureOraclev10g>