<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureOraclev10g class="oracle.dbtools.crest.model.design.storage.oracle.v10g.StoredProcedureOraclev10g" name="XXPBSA_HO_REQUEST_PBSA_TOKEN" directorySegmentName="seg_0" id="69F3C606-5C1D-5C2A-813B-25434E9DD0AD">
<sourceConnName>LSL_Cloud_apex</sourceConnName>
<sourceObjSchema>APEX</sourceObjSchema>
<sourceObjName>XXPBSA_HO_REQUEST_PBSA_TOKEN</sourceObjName>
<createdBy>sjayasinghe1</createdBy>
<createdTime>2019-04-29 11:48:30 UTC</createdTime>
<ownerDesignName>lsl-doc</ownerDesignName>
<owner>FB5DE12D-4EA4-254B-AA97-4ED35945C6A7</owner>
<source>CREATE OR REPLACE PROCEDURE APEX.XXPBSA_HO_REQUEST_PBSA_TOKEN --(&lt;br/&gt;                                                     --  p_client_id     in varchar2&lt;br/&gt;                                                     --, p_client_secret in varchar2&lt;br/&gt;                                                     --  p_token_type    out varchar2&lt;br/&gt;                                                     --, p_access_token  out varchar2&lt;br/&gt;                                                     --, p_expires_in    out number&lt;br/&gt;                                                     --)&lt;br/&gt;AS&lt;br/&gt;        l_clob           CLOB;&lt;br/&gt;        l_buffer         varchar2(32767);&lt;br/&gt;        l_amount         number;&lt;br/&gt;        l_offset         number;&lt;br/&gt;        l_client_id      varchar2(2000);&lt;br/&gt;        l_client_secret  varchar2(2000);&lt;br/&gt;        l_url            varchar2(1000);&lt;br/&gt;        l_https_host     varchar2(100);&lt;br/&gt;        l_wallet_path    varchar2(1000);&lt;br/&gt;        l_token_type     varchar2(20);&lt;br/&gt;        l_access_token   varchar2(2000);&lt;br/&gt;        l_expires_in     number;&lt;br/&gt;&lt;br/&gt;BEGIN&lt;br/&gt;        --apex_web_service.g_request_headers(1).name    := &apos;User-Agent&apos;;&lt;br/&gt;        --apex_web_service.g_request_headers(1).value   := &apos;Mozilla&apos;;&lt;br/&gt;        -- Request grants for username and password&lt;br/&gt;        -- Get the token from the web service.&lt;br/&gt;        --l_client_id     := p_client_id;&lt;br/&gt;        --l_client_secret := p_client_secret;&lt;br/&gt;&lt;br/&gt;        select CLIENT_ID&lt;br/&gt;              ,CLIENT_SECRET&lt;br/&gt;              ,URL&lt;br/&gt;              ,HTTPS_HOST&lt;br/&gt;              ,WALLET_PATH&lt;br/&gt;        into l_client_id&lt;br/&gt;            ,l_client_secret&lt;br/&gt;            ,l_url&lt;br/&gt;            ,l_https_host&lt;br/&gt;            ,l_wallet_path&lt;br/&gt;        from XXPBSA_HO_OAUTH&lt;br/&gt;        where rownum = 1;&lt;br/&gt;&lt;br/&gt;        select APEX_WEB_SERVICE.make_rest_request (    p_url         =&gt; l_url,&lt;br/&gt;                                                       p_http_method =&gt; &apos;POST&apos;,&lt;br/&gt;                                                       p_body        =&gt; &apos;grant_type=password&apos;||&apos;&amp;&apos;||&apos;username=&apos;||l_client_id||&apos;&amp;&apos;||&apos;password=&apos;||l_client_secret,&lt;br/&gt;                                                       -- p_parm_name   =&gt; apex_util.string_to_table(&apos;appid:format&apos;),&lt;br/&gt;                                                       -- p_parm_value  =&gt; apex_util.string_to_table(apex_application.g_x01||&apos;:&apos;||apex_application.g_x02)&lt;br/&gt;                                                       p_wallet_path =&gt; l_wallet_path,&lt;br/&gt;                                                       p_wallet_pwd  =&gt; null,&lt;br/&gt;                                                       p_https_host  =&gt; l_https_host&lt;br/&gt;                                                     )&lt;br/&gt;        into l_clob&lt;br/&gt;        from dual;&lt;br/&gt;        -- reads the invoked web service response for OAuth tokenization&lt;br/&gt;        -- clob typed object reads twice and need improvements&lt;br/&gt;&lt;br/&gt;        select json_value(l_clob, &apos;$.token_type&apos;)&lt;br/&gt;        into l_token_type&lt;br/&gt;        from dual;&lt;br/&gt;&lt;br/&gt;        --p_token_type := l_token_type;&lt;br/&gt;&lt;br/&gt;        select json_value(l_clob, &apos;$.access_token&apos;)&lt;br/&gt;        into l_access_token&lt;br/&gt;        from dual;&lt;br/&gt;&lt;br/&gt;        --p_access_token := l_access_token;&lt;br/&gt;&lt;br/&gt;        select json_value(l_clob, &apos;$.expires_in&apos;)&lt;br/&gt;        into l_expires_in&lt;br/&gt;        from dual;&lt;br/&gt;&lt;br/&gt;        --p_expires_in := l_expires_in;&lt;br/&gt;&lt;br/&gt;        update XXPBSA_HO_OAUTH &lt;br/&gt;        set TOKEN_TYPE = l_token_type,&lt;br/&gt;            ACCESS_TOKEN = l_access_token,&lt;br/&gt;            EXPIRES_IN_SEC = l_expires_in,&lt;br/&gt;            START_DATE = SYSDATE,&lt;br/&gt;            END_DATE = SYSDATE + (((l_expires_in)/3600)/24)&lt;br/&gt;        where rownum = 1;&lt;br/&gt;&lt;br/&gt;        commit;&lt;br/&gt;--                                               &lt;br/&gt;--        l_amount := 32000;&lt;br/&gt;--        l_offset := 1;&lt;br/&gt;--&lt;br/&gt;--        begin&lt;br/&gt;--            loop&lt;br/&gt;--                dbms_lob.read( l_clob, l_amount, l_offset, l_buffer );&lt;br/&gt;--                htp.p(l_buffer);&lt;br/&gt;--                l_offset := l_offset + l_amount;&lt;br/&gt;--                l_amount := 32000;&lt;br/&gt;--            end loop;&lt;br/&gt;--        exception&lt;br/&gt;--            when no_data_found then&lt;br/&gt;--                DBMS_OUTPUT.put_line(&apos;Message: unsuccessful operation&apos;);&lt;br/&gt;--            when others then&lt;br/&gt;--                DBMS_OUTPUT.put_line(SQLERRM);&lt;br/&gt;--        end;&lt;br/&gt;END;</source>
</StoredProcedureOraclev10g>