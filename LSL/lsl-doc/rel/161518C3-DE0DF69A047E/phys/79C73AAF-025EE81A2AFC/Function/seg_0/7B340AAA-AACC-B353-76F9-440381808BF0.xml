<?xml version = '1.0' encoding = 'UTF-8'?>
<FunctionOracle class="oracle.dbtools.crest.model.design.storage.oracle.FunctionOracle" name="XXPBSA_SUP_RET_PAYLOAD" directorySegmentName="seg_0" id="7B340AAA-AACC-B353-76F9-440381808BF0">
<sourceConnName>LSL_Cloud_apex</sourceConnName>
<sourceObjSchema>APEX</sourceObjSchema>
<sourceObjName>XXPBSA_SUP_RET_PAYLOAD</sourceObjName>
<createdBy>sjayasinghe1</createdBy>
<createdTime>2019-04-29 11:48:34 UTC</createdTime>
<ownerDesignName>lsl-doc</ownerDesignName>
<owner>FB5DE12D-4EA4-254B-AA97-4ED35945C6A7</owner>
<source>CREATE OR REPLACE function APEX.XXPBSA_SUP_RET_PAYLOAD&lt;br/&gt;return varchar2&lt;br/&gt;as&lt;br/&gt;&lt;br/&gt;  l_msg    varchar2(20000);&lt;br/&gt;&lt;br/&gt;BEGIN&lt;br/&gt;select *&lt;br/&gt;into l_msg&lt;br/&gt;from&lt;br/&gt;(&lt;br/&gt;&lt;br/&gt;select *&lt;br/&gt;from&lt;br/&gt;(&lt;br/&gt;select *&lt;br/&gt;from&lt;br/&gt;(&lt;br/&gt;select distinct&lt;br/&gt;json_object(&lt;br/&gt;                &apos;SupplierReturnId&apos;   --VALUE srh.SUPPLIERRETURNREQUESTID,&lt;br/&gt;                                            VALUE &lt;br/&gt;                                                    (   &lt;br/&gt;                                                      select SUPPLIERRETURNID&lt;br/&gt;                                                      from&lt;br/&gt;                                                      (&lt;br/&gt;                                                       select distinct sh.SUPPLIERRETURNID&lt;br/&gt;                                                       from SUPPLIERRETURNLINE sl,&lt;br/&gt;                                                            SUPPLIERRETURN sh&lt;br/&gt;                                                       where sh.SUPPLIERRETURNID = sl.SUPPLIERRETURNID&lt;br/&gt;                                                       order by 1 desc&lt;br/&gt;                                                      )&lt;br/&gt;                                                      where rownum = 1&lt;br/&gt;                                                    )&lt;br/&gt;                                            ,&lt;br/&gt;                &apos;PurchaseRequestId&apos;         VALUE ph.segment1,&lt;br/&gt;                &apos;SupplierId&apos;                VALUE srl.SupplierId,&lt;br/&gt;                &apos;Date&apos;                      VALUE TO_CHAR(systimestamp, &apos;yyyy-mm-dd&quot;T&quot;HH24:MI:SS.SSTZH:TZM&apos;),&lt;br/&gt;                &apos;Address&apos;  VALUE (&lt;br/&gt;                                 json_object(&apos;Street&apos;       VALUE srh.Street,&lt;br/&gt;                                             &apos;City&apos;         VALUE srh.City,&lt;br/&gt;                                             &apos;State&apos;        VALUE srh.State,&lt;br/&gt;                                             &apos;PostCode&apos;     VALUE srh.PostCode,&lt;br/&gt;                                             &apos;Country&apos;      VALUE srh.Country,&lt;br/&gt;                                             &apos;ContactName&apos;  VALUE srh.ContactName,&lt;br/&gt;                                             &apos;Phone&apos;        VALUE srh.phone,&lt;br/&gt;                                             &apos;Email&apos;        VALUE srh.email&lt;br/&gt;                                             )&lt;br/&gt;                                        ),&lt;br/&gt;                &apos;Lines&apos;  VALUE (&apos;[&apos;||&lt;br/&gt;                     json_object(&apos;SupplierReturnRequestLineId&apos;        VALUE (&lt;br/&gt;                     &lt;br/&gt;                                                                            select *&lt;br/&gt;                                                                            from&lt;br/&gt;                                                                            (&lt;br/&gt;                                                                            select l.SUPPLIERRETURNREQUESTID&lt;br/&gt;                                                                            from SUPPLIER_RET_REQUESTS_HEADER h, SUPPLIER_RET_REQUESTS_LINES l&lt;br/&gt;                                                                            where     (l.productid is null or l.productid =       &lt;br/&gt;                                                                                       (&lt;br/&gt;                                                                                       select *&lt;br/&gt;                                                                                       from&lt;br/&gt;                                                                                       (&lt;br/&gt;                                                                                       select distinct msi.attribute10&lt;br/&gt;                                                                                       from SUPPLIERRETURNLINE sl,&lt;br/&gt;                                                                                            SUPPLIERRETURN sh,&lt;br/&gt;                                                                                            mtl_system_items_b@DBLINK2 msi&lt;br/&gt;                                                                                       where sh.SUPPLIERRETURNID = sl.SUPPLIERRETURNID&lt;br/&gt;                                                                                             and msi.description = sl.title&lt;br/&gt;                                                                                       order by 1 desc&lt;br/&gt;                                                                                       )&lt;br/&gt;                                                                                       where rownum = 1&lt;br/&gt;                                                                                    )) and&lt;br/&gt;                                                                            (l.supplierid is null or l.supplierid = &lt;br/&gt;                                                                                    (           &lt;br/&gt;                                                                                       select *&lt;br/&gt;                                                                                       from&lt;br/&gt;                                                                                       (&lt;br/&gt;                                                                                       select distinct sh.supplierid&lt;br/&gt;                                                                                       from SUPPLIERRETURNLINE sl,&lt;br/&gt;                                                                                            SUPPLIERRETURN sh&lt;br/&gt;                                                                                       where sh.SUPPLIERRETURNID = sl.SUPPLIERRETURNID&lt;br/&gt;                                                                                       order by 1 desc&lt;br/&gt;                                                                                       )&lt;br/&gt;                                                                                       where rownum = 1&lt;br/&gt;                                                                                    )&lt;br/&gt;                                                                                    )&lt;br/&gt;                                                                                  and h.SUPPLIERRETURNREQUESTID = l.SUPPLIERRETURNREQUESTID&lt;br/&gt;                                                                                order by 1 desc&lt;br/&gt;                                                                                  )&lt;br/&gt;                                                                                where rownum = 1&lt;br/&gt;                                                                                  &lt;br/&gt;                     &lt;br/&gt;                                                                        ),&lt;br/&gt;                                                                            --VALUE TO_NUMBER(srl.SUPPLIERRETURNREQUESTID),&lt;br/&gt;                                 &apos;ProductId&apos;                      VALUE srl.ProductId,&lt;br/&gt;                                 &apos;Unit&apos;                           VALUE &apos;ea&apos;,&lt;br/&gt;                                 &apos;Quantity&apos;                       VALUE TO_NUMBER(srl.Quantity*-1),&lt;br/&gt;                                 &apos;PerUnitCost&apos;                    VALUE TO_NUMBER(prl.PerUnitCost),&lt;br/&gt;                                 &apos;PerUnitCostTax&apos;                 VALUE TO_NUMBER(prl.PerUnitCostTax),&lt;br/&gt;                                 &apos;LineTotalCost&apos;                  VALUE TO_NUMBER(prl.LineTotalCost),&lt;br/&gt;                                 &apos;LineTotalCostTax&apos;               VALUE TO_NUMBER(prl.LineTotalCostTax),&lt;br/&gt;                                 &apos;MrpIncTax&apos;                      VALUE TO_NUMBER(prl.PERUNITPRICE)+TO_NUMBER(prl.PERUNITPRICETAX),&lt;br/&gt;                                 &apos;TaxCode&apos;                        VALUE &apos;VAT&apos;,&lt;br/&gt;                                 &apos;Status&apos;                         VALUE &apos;Approved&apos;&lt;br/&gt;                                 )||&apos;]&apos;&lt;br/&gt;                            )&lt;br/&gt;                                  FORMAT JSON) J&lt;br/&gt;      FROM po_headers_all@DBLINK2        ph,&lt;br/&gt;           po_lines_all@DBLINK2          pl,&lt;br/&gt;           po_line_locations_all@DBLINK2 pll,&lt;br/&gt;           po_distributions_all@DBLINK2  pd,&lt;br/&gt;           mtl_parameters@DBLINK2        mp,&lt;br/&gt;           mtl_system_items_b@DBLINK2    msi,&lt;br/&gt;           PO_REQ_DISTRIBUTIONS_ALL@DBLINK2 PRDA,&lt;br/&gt;           PO_REQUISITION_LINES_ALL@DBLINK2 PRLA,&lt;br/&gt;           PO_REQUISITION_HEADERS_ALL@DBLINK2 PRHA,&lt;br/&gt;           deliverysummary ds,&lt;br/&gt;           deliverysummaryline dsl,&lt;br/&gt;           PURCHASE_REQUESTS_HEADER prh,&lt;br/&gt;           PURCHASE_REQUESTS_LINES prl,&lt;br/&gt;           SUPPLIER_RET_REQUESTS_HEADER srh,&lt;br/&gt;           SUPPLIER_RET_REQUESTS_LINES srl,&lt;br/&gt;           ap_suppliers@DBLINK2 aps--,&lt;br/&gt;--           (&lt;br/&gt;--            SELECT inv.invoice_id, pda.po_distribution_id, pl.item_id, inv.invoice_id&lt;br/&gt;--            FROM ap_invoice_distributions_all inv,&lt;br/&gt;--                 po_distributions_all         pda,&lt;br/&gt;--                 po_lines_all                 pl&lt;br/&gt;--            WHERE 1=1&lt;br/&gt;--                  and rownum = 1&lt;br/&gt;--                  AND pda.po_line_id = pl.po_line_id&lt;br/&gt;--                  and inv.po_distribution_id = pda.po_distribution_id &lt;br/&gt;--            order by inv.invoice_id desc&lt;br/&gt;--            ) inv&lt;br/&gt;     WHERE 1 = 1&lt;br/&gt;           and pl.po_header_id = ph.po_header_id&lt;br/&gt;--           and pd.po_distribution_id = inv.po_distribution_id&lt;br/&gt;--           and msi.inventory_item_id = inv.item_id&lt;br/&gt;           and srh.SUPPLIERRETURNREQUESTID = srl.SUPPLIERRETURNREQUESTID&lt;br/&gt;           and srl.PRODUCTID = msi.attribute10&lt;br/&gt;           and srl.SUPPLIERID = aps.attribute10&lt;br/&gt;           and srh.STATUS_FLAG = &apos;A&apos;&lt;br/&gt;           AND pl.po_line_id = pll.po_line_id&lt;br/&gt;           AND pd.line_location_id = pll.line_location_id&lt;br/&gt;           AND pd.po_line_id = pl.po_line_id&lt;br/&gt;           AND pll.ship_to_organization_id = mp.organization_id&lt;br/&gt;           AND ds.DeliveryId = dsl.DeliveryId&lt;br/&gt;           AND ds.EXTERNALREFERENCENUMBER = ph.SEGMENT1&lt;br/&gt;           AND msi.inventory_item_id = pl.item_id&lt;br/&gt;           AND msi.segment1 = dsl.PARTNUMBER&lt;br/&gt;           AND pd.REQ_DISTRIBUTION_ID = PRDA.DISTRIBUTION_ID&lt;br/&gt;           AND PRDA.REQUISITION_LINE_ID = PRLA.REQUISITION_LINE_ID&lt;br/&gt;           AND PRLA.REQUISITION_HEADER_ID = PRHA.REQUISITION_HEADER_ID&lt;br/&gt;        )&lt;br/&gt;        where 1=1&lt;br/&gt;        order by 1 desc&lt;br/&gt;        )&lt;br/&gt;        where rownum = 1&lt;br/&gt;&lt;br/&gt;        )&lt;br/&gt;        where rownum = 1;&lt;br/&gt;--select &lt;br/&gt;--json_object(&lt;br/&gt;--                &apos;SupplierReturnId&apos;     VALUE srh.SUPPLIERRETURNREQUESTID,&lt;br/&gt;--                &apos;PurchaseRequestId&apos;    VALUE PRHA.INTERFACE_SOURCE_CODE,&lt;br/&gt;--                &apos;SupplierId&apos;           VALUE srl.SupplierId,&lt;br/&gt;--                &apos;Date&apos;                 VALUE TO_CHAR(systimestamp, &apos;yyyy-mm-dd&quot;T&quot;HH24:MI:SS.SSTZH:TZM&apos;),&lt;br/&gt;--                &apos;Address&apos;  VALUE (&lt;br/&gt;--                                 json_object(&apos;Street&apos;       VALUE srh.Street,&lt;br/&gt;--                                             &apos;City&apos;         VALUE srh.City,&lt;br/&gt;--                                             &apos;State&apos;        VALUE srh.State,&lt;br/&gt;--                                             &apos;PostCode&apos;     VALUE srh.PostCode,&lt;br/&gt;--                                             &apos;Country&apos;      VALUE srh.Country,&lt;br/&gt;--                                             &apos;ContactName&apos;  VALUE srh.ContactName,&lt;br/&gt;--                                             &apos;Phone&apos;        VALUE srh.phone,&lt;br/&gt;--                                             &apos;Email&apos;        VALUE srh.email&lt;br/&gt;--                                             )&lt;br/&gt;--                                        ),&lt;br/&gt;--                &apos;Lines&apos;  VALUE (&apos;[&apos;||&lt;br/&gt;--                     json_object(&apos;SupplierReturnRequestLineId&apos;    VALUE TO_NUMBER(srl.SUPPLIERRETURNREQUESTLINEID),&lt;br/&gt;--                                 &apos;ProductId&apos;                      VALUE srl.ProductId,&lt;br/&gt;--                                 &apos;Quantity&apos;                       VALUE TO_NUMBER(srl.Quantity),&lt;br/&gt;--                                 &apos;PerUnitCost&apos;                    VALUE TO_NUMBER(PRLA.ATTRIBUTE9),&lt;br/&gt;--                                 &apos;PerUnitCostTax&apos;                 VALUE TO_NUMBER(PRLA.ATTRIBUTE8),&lt;br/&gt;--                                 &apos;LineTotalCost&apos;                  VALUE TO_NUMBER(PRLA.ATTRIBUTE7),&lt;br/&gt;--                                 &apos;LineTotalCostTax&apos;               VALUE TO_NUMBER(PRLA.ATTRIBUTE6),&lt;br/&gt;--                                 &apos;MrpIncTax&apos;                      VALUE TO_NUMBER(PRLA.ATTRIBUTE6)+TO_NUMBER(PRLA.ATTRIBUTE7),&lt;br/&gt;--                                 &apos;Status&apos;                         VALUE &apos;Approved&apos;&lt;br/&gt;--                                 )||&apos;]&apos;&lt;br/&gt;--                            )&lt;br/&gt;--                                  FORMAT JSON) J&lt;br/&gt;--      into l_msg&lt;br/&gt;--      FROM SUPPLIER_RET_REQUESTS_HEADER srh,&lt;br/&gt;--           SUPPLIER_RET_REQUESTS_LINES srl,&lt;br/&gt;--           po_lines_all@DBLINK2 pl,&lt;br/&gt;--           po_line_locations_all@DBLINK2 pll,&lt;br/&gt;--           po_distributions_all@DBLINK2  pd,&lt;br/&gt;--           mtl_parameters@DBLINK2        mp,&lt;br/&gt;--           mtl_system_items_b@DBLINK2    msi,&lt;br/&gt;--           PO_REQ_DISTRIBUTIONS_ALL@DBLINK2 PRDA,&lt;br/&gt;--           PO_REQUISITION_LINES_ALL@DBLINK2 PRLA,&lt;br/&gt;--           PO_REQUISITION_HEADERS_ALL@DBLINK2 PRHA,&lt;br/&gt;--           ap_suppliers@DBLINK2 aps&lt;br/&gt;--     WHERE 1 = 1&lt;br/&gt;--           and srh.SupplierReturnRequestId = srl.SupplierReturnRequestId&lt;br/&gt;--           and srl.PRODUCTID = msi.attribute10(+)&lt;br/&gt;--           and srl.SUPPLIERID = aps.attribute10(+)&lt;br/&gt;--           and NVL(srh.STATUS_FLAG, &apos;A&apos;) = &apos;A&apos;&lt;br/&gt;--           AND pl.po_line_id = pll.po_line_id&lt;br/&gt;--           AND pd.line_location_id = pll.line_location_id&lt;br/&gt;--           AND pd.po_line_id = pl.po_line_id&lt;br/&gt;--           AND pll.ship_to_organization_id = mp.organization_id&lt;br/&gt;--           AND msi.inventory_item_id = pl.item_id&lt;br/&gt;--           AND pd.REQ_DISTRIBUTION_ID = PRDA.DISTRIBUTION_ID&lt;br/&gt;--           AND PRDA.REQUISITION_LINE_ID = PRLA.REQUISITION_LINE_ID&lt;br/&gt;--           AND PRLA.REQUISITION_HEADER_ID = PRHA.REQUISITION_HEADER_ID&lt;br/&gt;--           AND rownum = 1;&lt;br/&gt;&lt;br/&gt;  return l_msg;&lt;br/&gt;&lt;br/&gt;END;</source>
</FunctionOracle>