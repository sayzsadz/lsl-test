<?xml version = '1.0' encoding = 'UTF-8'?>
<FunctionOracle class="oracle.dbtools.crest.model.design.storage.oracle.FunctionOracle" name="XXPBSA_PO_PAYLOAD" directorySegmentName="seg_0" id="FA199B4C-6DCC-C918-E21F-8196509C0993">
<sourceConnName>LSL_Cloud_apex</sourceConnName>
<sourceObjSchema>APEX</sourceObjSchema>
<sourceObjName>XXPBSA_PO_PAYLOAD</sourceObjName>
<createdBy>sjayasinghe1</createdBy>
<createdTime>2019-04-29 11:48:32 UTC</createdTime>
<ownerDesignName>lsl-doc</ownerDesignName>
<owner>FB5DE12D-4EA4-254B-AA97-4ED35945C6A7</owner>
<source>CREATE OR REPLACE function APEX.XXPBSA_PO_PAYLOAD (p_po_num varchar2)&lt;br/&gt;return varchar2&lt;br/&gt;as&lt;br/&gt;&lt;br/&gt;  l_msg    varchar2(20000);&lt;br/&gt;  l_po_num varchar2(20);&lt;br/&gt;  &lt;br/&gt;BEGIN&lt;br/&gt;&lt;br/&gt;    l_po_num := p_po_num;&lt;br/&gt;&lt;br/&gt;&lt;br/&gt;--                SELECT json_object(&apos;PurchaseOrderId&apos;   VALUE TO_NUMBER(pha_outer.SEGMENT1),&lt;br/&gt;--                                   &apos;SupplierId&apos;        VALUE pl_outer.SupplierId,&lt;br/&gt;--                                   &apos;Lines&apos;             VALUE (&apos;[&apos;||&lt;br/&gt;--                                                             json_object(&apos;PurchaseRequestLineId&apos;    VALUE TO_NUMBER(pl_outer.PurchaseRequestLineId),&lt;br/&gt;--                                                                         &apos;DateRequired&apos;             VALUE PRLA_outer.NEED_BY_DATE,&lt;br/&gt;--                                                                         &apos;ProductId&apos;                VALUE pl_outer.ProductId,&lt;br/&gt;--                                                                         &apos;Quantity&apos;                 VALUE TO_NUMBER(pl_outer.Quantity),&lt;br/&gt;--                                                                         &apos;Unit&apos;                     VALUE pl_outer.Unit,&lt;br/&gt;--                                                                         &apos;PerUnitCost&apos;              VALUE TO_NUMBER(pl_outer.PerUnitCost),&lt;br/&gt;--                                                                         &apos;PerUnitCostTax&apos;           VALUE TO_NUMBER(pl_outer.PerUnitCostTax),&lt;br/&gt;--                                                                         &apos;LineTotalCost&apos;            VALUE TO_NUMBER(pl_outer.LineTotalCost),&lt;br/&gt;--                                                                         &apos;LineTotalCostTax&apos;         VALUE TO_NUMBER(pl_outer.LineTotalCostTax),&lt;br/&gt;--                                                                         &apos;MrpIncTax&apos;                VALUE TO_NUMBER(pl_outer.PERUNITPRICE)+TO_NUMBER(pl_outer.PERUNITPRICETAX),&lt;br/&gt;--                                                                         &apos;TaxCode&apos;                  VALUE &apos;GST&apos;,&lt;br/&gt;--                                                                         &apos;Status&apos;                   VALUE INITCAP(pha_outer.AUTHORIZATION_STATUS)&lt;br/&gt;--                                                                         )||&apos;]&apos;&lt;br/&gt;--                                                                         )&lt;br/&gt;--                                  FORMAT JSON)&lt;br/&gt;--              into l_msg&lt;br/&gt;--              from PURCHASE_REQUESTS_LINES pl_outer&lt;br/&gt;--                  ,PURCHASE_REQUESTS_HEADER ph_outer&lt;br/&gt;--                  ,PO_HEADERS_ALL@DBLINK2 pha_outer&lt;br/&gt;--                  ,PO_LINES_ALL@DBLINK2 pla_outer&lt;br/&gt;--                  ,PO_DISTRIBUTIONS_ALL@DBLINK2 PDA_outer&lt;br/&gt;--                  ,PO_REQ_DISTRIBUTIONS_ALL@DBLINK2 PRDA_outer&lt;br/&gt;--                  ,PO_REQUISITION_LINES_ALL@DBLINK2 PRLA_outer&lt;br/&gt;--                  ,PO_REQUISITION_HEADERS_ALL@DBLINK2 PRHA_outer&lt;br/&gt;--            WHERE  1 = 1&lt;br/&gt;--                   AND ph_outer.PurchaseRequestId = pl_outer.PurchaseRequestId&lt;br/&gt;--                   and NVL(PRHA_outer.INTERFACE_SOURCE_CODE, 0) = NVL(pl_outer.PurchaseOrderId, ph_outer.PurchaseRequestId)&lt;br/&gt;--                   AND PDA_outer.REQ_DISTRIBUTION_ID = PRDA_outer.DISTRIBUTION_ID&lt;br/&gt;--                   AND PRDA_outer.REQUISITION_LINE_ID = PRLA_outer.REQUISITION_LINE_ID&lt;br/&gt;--                   AND PRLA_outer.REQUISITION_HEADER_ID = PRHA_outer.REQUISITION_HEADER_ID&lt;br/&gt;--                   AND pda_outer.po_line_id = pla_outer.po_line_id&lt;br/&gt;--                   AND PDA_outer.REQ_DISTRIBUTION_ID = PRDA_outer.DISTRIBUTION_ID&lt;br/&gt;--                   AND pha_outer.po_header_id = pla_outer.po_header_id&lt;br/&gt;--                   AND pha_outer.SEGMENT1 = l_po_num&lt;br/&gt;--                   AND pha_outer.authorization_status = &apos;APPROVED&apos;&lt;br/&gt;--                   AND pha_outer.attribute13 is null;&lt;br/&gt;&lt;br/&gt; SELECT &lt;br/&gt; &lt;br/&gt; json_object(&apos;PurchaseOrderId&apos;   VALUE h.SEGMENT1,&lt;br/&gt;                   &apos;SupplierId&apos;        VALUE h.SupplierId,&lt;br/&gt;                   &apos;Lines&apos;             VALUE (&lt;br/&gt;                   &apos;[&apos;||listagg(l.csv,&apos;, &apos;) within group(order by l.csv) ||&apos;]&apos;&lt;br/&gt;                   )&lt;br/&gt;                  FORMAT JSON)&lt;br/&gt; into l_msg&lt;br/&gt; from&lt;br/&gt; (select distinct TO_NUMBER(pha_outer.SEGMENT1) SEGMENT1,&lt;br/&gt;         pl_outer.SupplierId&lt;br/&gt;  from PURCHASE_REQUESTS_LINES pl_outer&lt;br/&gt;                  ,PURCHASE_REQUESTS_HEADER ph_outer&lt;br/&gt;                  ,PO_HEADERS_ALL@DBLINK2 pha_outer&lt;br/&gt;                  ,PO_LINES_ALL@DBLINK2 pla_outer&lt;br/&gt;                  ,PO_DISTRIBUTIONS_ALL@DBLINK2 PDA_outer&lt;br/&gt;                  ,PO_REQ_DISTRIBUTIONS_ALL@DBLINK2 PRDA_outer&lt;br/&gt;                  ,PO_REQUISITION_LINES_ALL@DBLINK2 PRLA_outer&lt;br/&gt;                  ,PO_REQUISITION_HEADERS_ALL@DBLINK2 PRHA_outer&lt;br/&gt;            WHERE  1 = 1&lt;br/&gt;                   AND ph_outer.PurchaseRequestId = pl_outer.PurchaseRequestId&lt;br/&gt;                   and NVL(PRHA_outer.INTERFACE_SOURCE_CODE, 0) = NVL(pl_outer.PurchaseOrderId, ph_outer.PurchaseRequestId)&lt;br/&gt;                   AND PDA_outer.REQ_DISTRIBUTION_ID = PRDA_outer.DISTRIBUTION_ID&lt;br/&gt;                   AND PRDA_outer.REQUISITION_LINE_ID = PRLA_outer.REQUISITION_LINE_ID&lt;br/&gt;                   AND PRLA_outer.REQUISITION_HEADER_ID = PRHA_outer.REQUISITION_HEADER_ID&lt;br/&gt;                   AND pda_outer.po_line_id = pla_outer.po_line_id&lt;br/&gt;                   AND PDA_outer.REQ_DISTRIBUTION_ID = PRDA_outer.DISTRIBUTION_ID&lt;br/&gt;                   AND pha_outer.po_header_id = pla_outer.po_header_id&lt;br/&gt;                   AND pha_outer.SEGMENT1 = l_po_num&lt;br/&gt;                   AND pha_outer.authorization_status = &apos;APPROVED&apos;&lt;br/&gt;                   AND pha_outer.attribute13 is null&lt;br/&gt; ) h,&lt;br/&gt; (&lt;br/&gt;                                              select  distinct json_object(&apos;PurchaseRequestLineId&apos; VALUE TO_NUMBER(pl_outer.PurchaseRequestLineId),&lt;br/&gt;                                                                             &apos;DateRequired&apos;             VALUE PRLA_outer.NEED_BY_DATE,&lt;br/&gt;                                                                             &apos;ProductId&apos;                VALUE pl_outer.ProductId,&lt;br/&gt;                                                                             &apos;Quantity&apos;                 VALUE TO_NUMBER(pl_outer.Quantity),&lt;br/&gt;                                                                             &apos;Unit&apos;                     VALUE pl_outer.Unit,&lt;br/&gt;                                                                             &apos;PerUnitCost&apos;              VALUE TO_NUMBER(pl_outer.PerUnitCost),&lt;br/&gt;                                                                             &apos;PerUnitCostTax&apos;           VALUE TO_NUMBER(pl_outer.PerUnitCostTax),&lt;br/&gt;                                                                             &apos;LineTotalCost&apos;            VALUE TO_NUMBER(pl_outer.LineTotalCost),&lt;br/&gt;                                                                             &apos;LineTotalCostTax&apos;         VALUE TO_NUMBER(pl_outer.LineTotalCostTax),&lt;br/&gt;                                                                             &apos;MrpIncTax&apos;                VALUE TO_NUMBER(pl_outer.PERUNITPRICE)+TO_NUMBER(pl_outer.PERUNITPRICETAX),&lt;br/&gt;                                                                             &apos;TaxCode&apos;                  VALUE &apos;VAT&apos;,&lt;br/&gt;                                                                             &apos;Status&apos;                   VALUE INITCAP(pha_outer.AUTHORIZATION_STATUS)&lt;br/&gt;                                                         )  csv&lt;br/&gt;        from PURCHASE_REQUESTS_LINES pl_outer&lt;br/&gt;                  ,PURCHASE_REQUESTS_HEADER ph_outer&lt;br/&gt;                  ,PO_HEADERS_ALL@DBLINK2 pha_outer&lt;br/&gt;                  ,PO_LINES_ALL@DBLINK2 pla_outer&lt;br/&gt;                  ,PO_DISTRIBUTIONS_ALL@DBLINK2 PDA_outer&lt;br/&gt;                  ,PO_REQ_DISTRIBUTIONS_ALL@DBLINK2 PRDA_outer&lt;br/&gt;                  ,PO_REQUISITION_LINES_ALL@DBLINK2 PRLA_outer&lt;br/&gt;                  ,PO_REQUISITION_HEADERS_ALL@DBLINK2 PRHA_outer&lt;br/&gt;            WHERE  1 = 1&lt;br/&gt;                   AND ph_outer.PurchaseRequestId = pl_outer.PurchaseRequestId&lt;br/&gt;                   and NVL(PRHA_outer.INTERFACE_SOURCE_CODE, 0) = NVL(pl_outer.PurchaseOrderId, ph_outer.PurchaseRequestId)&lt;br/&gt;                   AND PDA_outer.REQ_DISTRIBUTION_ID = PRDA_outer.DISTRIBUTION_ID&lt;br/&gt;                   AND PRDA_outer.REQUISITION_LINE_ID = PRLA_outer.REQUISITION_LINE_ID&lt;br/&gt;                   AND PRLA_outer.REQUISITION_HEADER_ID = PRHA_outer.REQUISITION_HEADER_ID&lt;br/&gt;                   AND pda_outer.po_line_id = pla_outer.po_line_id&lt;br/&gt;                   AND PDA_outer.REQ_DISTRIBUTION_ID = PRDA_outer.DISTRIBUTION_ID&lt;br/&gt;                   AND pha_outer.po_header_id = pla_outer.po_header_id&lt;br/&gt;                   AND pha_outer.SEGMENT1 = l_po_num&lt;br/&gt;                   AND pha_outer.authorization_status = &apos;APPROVED&apos;&lt;br/&gt;                   AND pha_outer.attribute13 is null&lt;br/&gt;                   AND pl_outer.STATUS_FLAG != &apos;R&apos;&lt;br/&gt;        )l&lt;br/&gt;    where 1=1&lt;br/&gt;    group by h.SEGMENT1, h.SupplierId&lt;br/&gt;    order by SEGMENT1;&lt;br/&gt;    &lt;br/&gt;  return l_msg;&lt;br/&gt;&lt;br/&gt;END;</source>
</FunctionOracle>