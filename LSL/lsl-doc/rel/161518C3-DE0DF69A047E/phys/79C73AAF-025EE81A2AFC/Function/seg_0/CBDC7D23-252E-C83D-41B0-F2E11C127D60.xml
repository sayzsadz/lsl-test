<?xml version = '1.0' encoding = 'UTF-8'?>
<FunctionOracle class="oracle.dbtools.crest.model.design.storage.oracle.FunctionOracle" name="XXPBSA_REQUEST_PBSAPOS_DATA" directorySegmentName="seg_0" id="CBDC7D23-252E-C83D-41B0-F2E11C127D60">
<sourceConnName>LSL_Cloud_apex</sourceConnName>
<sourceObjSchema>APEX</sourceObjSchema>
<sourceObjName>XXPBSA_REQUEST_PBSAPOS_DATA</sourceObjName>
<createdBy>sjayasinghe1</createdBy>
<createdTime>2019-04-29 11:48:33 UTC</createdTime>
<ownerDesignName>lsl-doc</ownerDesignName>
<owner>FB5DE12D-4EA4-254B-AA97-4ED35945C6A7</owner>
<source>CREATE OR REPLACE function APEX.XXPBSA_REQUEST_PBSAPOS_DATA (&lt;br/&gt;                                                          p_url           in varchar2&lt;br/&gt;                                                        --, p_token_type    in varchar2&lt;br/&gt;                                                        --, p_access_token  in varchar2&lt;br/&gt;                                                        , p_date_from     in varchar2&lt;br/&gt;                                                        , p_date_to       in varchar2&lt;br/&gt;                                                        , p_store_id      in number&lt;br/&gt;                                                        )&lt;br/&gt;return CLOB&lt;br/&gt;is                                                      &lt;br/&gt;  l_clob         CLOB;&lt;br/&gt;  l_buffer       varchar2(32767);&lt;br/&gt;  l_amount       number;&lt;br/&gt;  l_offset       number;&lt;br/&gt;  l_body         varchar2(100);&lt;br/&gt;  l_date_from    varchar2(30);&lt;br/&gt;  l_date_to      varchar2(30);&lt;br/&gt;  l_token_type   varchar2(30);&lt;br/&gt;  l_access_token varchar2(2000);&lt;br/&gt;  l_url          varchar2(1000);&lt;br/&gt;  l_https_host   varchar2(50);&lt;br/&gt;  l_wallet_path  varchar2(50);&lt;br/&gt;  -- l_site_name    varchar2(50) := &apos;http://104.197.10.182/ap1/api/v1/sales/summary&apos;;&lt;br/&gt;  -- l_username     varchar2(50) := &apos;ck_o3vuhza8bgmvu5lxronckr2favaxeiolh3izb&apos;;&lt;br/&gt;  -- l_password     varchar2(50) := &apos;cs_6bhldx7owbxrcmuo5ajcb7rql9mb0hglqrp97&apos;;&lt;br/&gt;  -- l_basic_base64 varchar2(2000);&lt;br/&gt;cursor cur&lt;br/&gt;is&lt;br/&gt;  select TOKEN_TYPE,&lt;br/&gt;         ACCESS_TOKEN,&lt;br/&gt;         HTTPS_HOST,&lt;br/&gt;         WALLET_PATH&lt;br/&gt;  from XXPBSA_OAUTH&lt;br/&gt;  where 1 = 1&lt;br/&gt;        and store_id = p_store_id;&lt;br/&gt;&lt;br/&gt;begin&lt;br/&gt;    for cur_rec in cur&lt;br/&gt;    loop&lt;br/&gt;        l_token_type := cur_rec.TOKEN_TYPE;&lt;br/&gt;        l_access_token := cur_rec.ACCESS_TOKEN;&lt;br/&gt;        l_https_host := cur_rec.HTTPS_HOST;&lt;br/&gt;        l_wallet_path := cur_rec.WALLET_PATH;&lt;br/&gt;&lt;br/&gt;  --l_token_type    := p_token_type;&lt;br/&gt;  --l_access_token  := p_access_token;&lt;br/&gt;  --l_basic_base64 := replace(utl_raw.cast_to_varchar2(utl_encode.base64_encode(utl_raw.cast_to_raw(l_site_name||&apos;\&apos;||l_username||&apos;:&apos;||l_password))),chr(13)||chr(10),&apos;&apos;);&lt;br/&gt;  --apex_web_service.g_request_headers(1).name    := &apos;User-Agent&apos;;&lt;br/&gt;  --apex_web_service.g_request_headers(1).value   := &apos;Mozilla&apos;;&lt;br/&gt;  apex_web_service.g_request_headers(1).name    := &apos;Authorization&apos;;&lt;br/&gt;  apex_web_service.g_request_headers(1).value   := l_token_type||&apos; &apos;||l_access_token;&lt;br/&gt;  apex_web_service.g_request_headers(2).name    := &apos;Content-Type&apos;;&lt;br/&gt;  apex_web_service.g_request_headers(2).value   := &apos;application/json&apos;;&lt;br/&gt;  --apex_web_service.g_request_headers(3).name    := &apos;Accept&apos;;  &lt;br/&gt;  --apex_web_service.g_request_headers(3).value   := &apos;application/json&apos;; &lt;br/&gt;  &lt;br/&gt;  l_date_from := p_date_from;&lt;br/&gt;  l_date_to := p_date_to;&lt;br/&gt;  &lt;br/&gt;  -- apex_json.parse&lt;br/&gt;  select  &apos;{&quot;DateFrom&quot;: &quot;&apos;||l_date_from||&apos;&quot;,&quot;DateTo&quot;: &quot;&apos;||l_date_to||&apos;&quot;}&apos;&lt;br/&gt;  into l_body&lt;br/&gt;  from dual;&lt;br/&gt;  &lt;br/&gt;  l_url := p_url;&lt;br/&gt;  &lt;br/&gt;  -- Invoke the PBSA web service to retrieve data&lt;br/&gt;  &lt;br/&gt;        select APEX_WEB_SERVICE.make_rest_request (    p_url         =&gt; l_url,&lt;br/&gt;                                                       p_http_method =&gt; &apos;POST&apos;,&lt;br/&gt;                                                       p_body        =&gt; l_body,&lt;br/&gt;                                                       -- p_parm_name   =&gt; apex_util.string_to_table(&apos;appid:format&apos;),&lt;br/&gt;                                                       -- p_parm_value  =&gt; apex_util.string_to_table(apex_application.g_x01||&apos;:&apos;||apex_application.g_x02)&lt;br/&gt;                                                       p_wallet_path =&gt; l_wallet_path,&lt;br/&gt;                                                       p_wallet_pwd  =&gt; null,&lt;br/&gt;                                                       p_https_host  =&gt; l_https_host&lt;br/&gt;                                                     )&lt;br/&gt;        into l_clob&lt;br/&gt;        from dual;&lt;br/&gt;                             &lt;br/&gt;                                                &lt;br/&gt;  --DBMS_OUTPUT.put_line(l_clob);&lt;br/&gt;  &lt;br/&gt;--  l_amount := 32000;&lt;br/&gt;--  l_offset := 1;&lt;br/&gt;--  &lt;br/&gt;--        begin&lt;br/&gt;--            loop&lt;br/&gt;--                dbms_lob.read( l_clob, l_amount, l_offset, l_buffer );&lt;br/&gt;--                htp.p(l_buffer);&lt;br/&gt;--                l_offset := l_offset + l_amount;&lt;br/&gt;--                l_amount := 32000;&lt;br/&gt;--            end loop;&lt;br/&gt;--        exception&lt;br/&gt;--            when no_data_found then&lt;br/&gt;--                DBMS_OUTPUT.put_line(&apos;Message: unsuccessful operation&apos;);&lt;br/&gt;--                l_clob := null;&lt;br/&gt;--            when others then&lt;br/&gt;--                DBMS_OUTPUT.put_line(SQLERRM);&lt;br/&gt;--                l_clob := null;&lt;br/&gt;--        end;&lt;br/&gt;--      &lt;br/&gt;      return l_clob;&lt;br/&gt;  end loop;    &lt;br/&gt;end;</source>
</FunctionOracle>